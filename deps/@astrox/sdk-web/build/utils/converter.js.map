{"version":3,"sources":["../../../src/utils/converter.ts"],"sourcesContent":["/* eslint-disable no-useless-catch */\nimport { Principal } from '@dfinity/principal';\nimport { sha224 } from 'js-sha256';\nimport { Buffer } from 'buffer';\nimport crc from 'crc';\nimport { ALPHANUM_REGEX, CANISTER_MAX_LENGTH, SUB_ACCOUNT_BYTE_LENGTH } from './constants';\nimport { AccountIdentifier, Balance, SubAccount } from './common/types';\n\nexport const uint8ArrayToBigInt = (array: Uint8Array): bigint => {\n  const view = new DataView(array.buffer, array.byteOffset, array.byteLength);\n  if (typeof view.getBigUint64 === 'function') {\n    return view.getBigUint64(0);\n  } else {\n    const high = BigInt(view.getUint32(0));\n    const low = BigInt(view.getUint32(4));\n\n    return (high << BigInt(32)) + low;\n  }\n};\n\nconst TWO_TO_THE_32 = BigInt(1) << BigInt(32);\nexport const bigIntToUint8Array = (value: bigint): Uint8Array => {\n  const array = new Uint8Array(8);\n  const view = new DataView(array.buffer, array.byteOffset, array.byteLength);\n  if (typeof view.setBigUint64 === 'function') {\n    view.setBigUint64(0, value);\n  } else {\n    view.setUint32(0, Number(value >> BigInt(32)));\n    view.setUint32(4, Number(value % TWO_TO_THE_32));\n  }\n\n  return array;\n};\n\nexport const arrayBufferToArrayOfNumber = (buffer: ArrayBuffer): Array<number> => {\n  const typedArray = new Uint8Array(buffer);\n  return Array.from(typedArray);\n};\n\nexport const arrayOfNumberToUint8Array = (numbers: Array<number>): Uint8Array => {\n  return new Uint8Array(numbers);\n};\n\nexport const arrayOfNumberToArrayBuffer = (numbers: Array<number>): ArrayBuffer => {\n  return arrayOfNumberToUint8Array(numbers).buffer;\n};\n\nexport const arrayBufferToNumber = (buffer: ArrayBuffer): number => {\n  const view = new DataView(buffer);\n  return view.getUint32(view.byteLength - 4);\n};\n\nexport const numberToArrayBuffer = (value: number, byteLength: number): ArrayBuffer => {\n  const buffer = new ArrayBuffer(byteLength);\n  new DataView(buffer).setUint32(byteLength - 4, value);\n  return buffer;\n};\n\nexport const asciiStringToByteArray = (text: string): Array<number> => {\n  return Array.from(text).map(c => c.charCodeAt(0));\n};\n\nexport const toSubAccountId = (subAccount: Array<number>): number => {\n  const bytes = arrayOfNumberToArrayBuffer(subAccount);\n  return arrayBufferToNumber(bytes);\n};\n\nexport const fromSubAccountId = (subAccountId: number): Array<number> => {\n  const buffer = numberToArrayBuffer(subAccountId, SUB_ACCOUNT_BYTE_LENGTH);\n  return arrayBufferToArrayOfNumber(buffer);\n};\n\nexport const accountIdentifierToBytes = (accountIdentifier: AccountIdentifier): Uint8Array => {\n  return Uint8Array.from(Buffer.from(accountIdentifier, 'hex')).subarray(4);\n};\n\nexport const accountIdentifierFromBytes = (accountIdentifier: Uint8Array): AccountIdentifier => {\n  return Buffer.from(accountIdentifier).toString('hex');\n};\n\nexport const principalToAccountIdentifier = (\n  principal: Principal,\n  subAccount?: Uint8Array,\n): string => {\n  // Hash (sha224) the principal, the subAccount and some padding\n  const padding = asciiStringToByteArray('\\x0Aaccount-id');\n\n  const shaObj = sha224.create();\n  shaObj.update([...padding, ...principal.toUint8Array(), ...(subAccount ?? Array(32).fill(0))]);\n  const hash = new Uint8Array(shaObj.array());\n\n  // Prepend the checksum of the hash and convert to a hex string\n  const checksum = calculateCrc32(hash);\n  const bytes = new Uint8Array([...checksum, ...hash]);\n  return toHexString(bytes);\n};\n\nexport const principalToSubAccount = (principal: Principal): SubAccount => {\n  const bytes = principal.toUint8Array();\n  const subAccount = new Uint8Array(32);\n  subAccount[0] = bytes.length;\n  subAccount.set(bytes, 1);\n  return subAccount;\n};\n\nexport const stringToAccountIdentifier = (str: string): AccountIdentifier | undefined => {\n  try {\n    if (str.length === 64) {\n      return str;\n    }\n    if (str.length === 63) {\n      return principalToAccountIdentifier(Principal.fromText(str));\n    }\n    return undefined;\n  } catch (error) {\n    return undefined;\n  }\n};\n\nconst toHexString = (bytes: Uint8Array) =>\n  bytes.reduce((str, byte) => str + byte.toString(16).padStart(2, '0'), '');\n\n// 4 bytes\nexport const calculateCrc32 = (bytes: Uint8Array): Uint8Array => {\n  const checksumArrayBuf = new ArrayBuffer(4);\n  const view = new DataView(checksumArrayBuf);\n  view.setUint32(0, crc.crc32(Buffer.from(bytes)), false);\n  return Buffer.from(checksumArrayBuf);\n};\n\nexport const E8S_PER_ICP = 100_000_000;\n\nexport enum TokenSymbol {\n  ICP = 'ICP',\n}\n\nexport const getDecimalFromSymbol = (sym: string) => {\n  switch (sym) {\n    case TokenSymbol.ICP:\n      return 8;\n    default:\n      return 8;\n  }\n};\n\nexport interface TokenMapItem {\n  [key: string]: { amount: number; symbol: string; balanceString: BalanceString };\n}\n\n\n\nexport const formatAssetBySymbol = (\n  _amount: bigint,\n  symbol: string,\n):\n  | { amount: number; symbol: string; balanceString: BalanceString }\n  | undefined => {\n  const balanceString = balanceToString(_amount, getDecimalFromSymbol(symbol));\n  const amount = Number(balanceString.total);\n  const tokenMap: TokenMapItem[] = [\n    {\n      ICP: {\n        amount: amount,\n        balanceString,\n        symbol: 'ICP',\n      },\n    },\n  ];\n\n  const found = tokenMap.find((v) => v[symbol] !== undefined);\n  return found?.[symbol];\n};\n\nexport const parseBalance = (balance: Balance): string => {\n  return (parseInt(balance.value, 10) / 10 ** balance.decimals).toString();\n};\n\nexport const balanceFromString = (\n  balance: string,\n  decimal = 8,\n): bigint => {\n  const list = balance.split('.');\n  const aboveZero = list[0];\n  const aboveZeroBigInt = BigInt(aboveZero) * BigInt(1 * 10 ** decimal);\n  let belowZeroBigInt = BigInt(0);\n  const belowZero = list[1];\n  if (belowZero !== undefined) {\n    belowZeroBigInt = BigInt(\n      belowZero.substring(0, decimal).padEnd(decimal, '0'),\n    );\n  }\n  return aboveZeroBigInt + belowZeroBigInt;\n};\n\nexport interface BalanceString {\n  total: string;\n  aboveZero: string;\n  belowZero: string;\n  formatAboveZero: string;\n}\n\nexport const balanceToString = (\n  balance: bigint,\n  decimal = 8,\n): BalanceString => {\n  const balanceString = balance.toString(10);\n  const balanceStringLength = balanceString.length;\n  let aboveZero = '0';\n  let belowZero = '0'.padEnd(decimal, '0');\n  if (balanceStringLength > decimal) {\n    belowZero = balanceString.substring(\n      balanceStringLength - decimal,\n      balanceStringLength,\n    );\n    aboveZero = balanceString.substring(0, balanceStringLength - decimal);\n  } else {\n    belowZero = balanceString.padStart(decimal, '0');\n  }\n  const formatAboveZero = String(aboveZero).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n\n  return { total: aboveZero + '.' + belowZero, aboveZero, belowZero, formatAboveZero };\n};\n\nexport const validateAccountId = (text: string): boolean =>\n  text.length === 64 && ALPHANUM_REGEX.test(text);\n\nexport const validatePrincipalId = (text: string) => {\n  try {\n    return text === Principal.fromText(text).toString();\n  } catch (e) {\n    return false;\n  }\n};\n\nexport const validateCanisterId = (text: string) => {\n  try {\n    return text.length <= CANISTER_MAX_LENGTH && validatePrincipalId(text);\n  } catch (e) {\n    return false;\n  }\n};\n\nexport enum AddressType {\n  PRINCIPAL = 'principal',\n  ACCOUNT = 'accountId',\n  CANISTER = 'canister',\n  ERC20 = 'erc20',\n  INVALID = 'invalid',\n}\n\nexport const getAddressType = (text: string) => {\n  try {\n    if (validateAccountId(text)) {\n      return AddressType.ACCOUNT;\n    } else if (validatePrincipalId(text)) {\n      return AddressType.PRINCIPAL;\n    } else if (validateCanisterId(text)) {\n      return AddressType.CANISTER;\n    }\n    return AddressType.INVALID;\n  } catch (error) {\n    throw error;\n  }\n};\n"],"names":["Principal","sha224","Buffer","crc","ALPHANUM_REGEX","CANISTER_MAX_LENGTH","SUB_ACCOUNT_BYTE_LENGTH","uint8ArrayToBigInt","array","view","DataView","buffer","byteOffset","byteLength","getBigUint64","high","BigInt","getUint32","low","TWO_TO_THE_32","bigIntToUint8Array","value","Uint8Array","setBigUint64","setUint32","Number","arrayBufferToArrayOfNumber","typedArray","Array","from","arrayOfNumberToUint8Array","numbers","arrayOfNumberToArrayBuffer","arrayBufferToNumber","numberToArrayBuffer","ArrayBuffer","asciiStringToByteArray","text","map","c","charCodeAt","toSubAccountId","subAccount","bytes","fromSubAccountId","subAccountId","accountIdentifierToBytes","accountIdentifier","subarray","accountIdentifierFromBytes","toString","principalToAccountIdentifier","principal","padding","shaObj","create","update","toUint8Array","fill","hash","checksum","calculateCrc32","toHexString","principalToSubAccount","length","set","stringToAccountIdentifier","str","fromText","undefined","error","reduce","byte","padStart","checksumArrayBuf","crc32","E8S_PER_ICP","TokenSymbol","getDecimalFromSymbol","sym","formatAssetBySymbol","_amount","symbol","balanceString","balanceToString","amount","total","tokenMap","ICP","found","find","v","parseBalance","balance","parseInt","decimals","balanceFromString","decimal","list","split","aboveZero","aboveZeroBigInt","belowZeroBigInt","belowZero","substring","padEnd","balanceStringLength","formatAboveZero","String","replace","validateAccountId","test","validatePrincipalId","e","validateCanisterId","AddressType","getAddressType"],"mappings":"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"}